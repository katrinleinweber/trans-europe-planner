<!DOCTYPE html>
<html lang="de">

<head>
    <meta name="description" content="Ohne Flugzeug quer durch Europa"/>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- maplibre -->
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.6.0/dist/maplibre-gl.css"/>
    <script src="https://unpkg.com/maplibre-gl@4.6.0/dist/maplibre-gl.js"></script>

    <!-- styles -->
    <link rel="stylesheet" href="style/style.css">
    <link rel="stylesheet" href="style/calendar.css">

    <!-- scripts -->
    <script src="style/map.js"></script> <!-- only contains css styles for map in js -->

    <script src="script/util.js"></script>
    <script src="script/types.js"></script>

    <script src="script/data/cities.js"></script>
    <script src="script/data/stations.js"></script>
    <script src="script/data/connections.js"></script>
    <script src="script/database.js"></script>

    <script src="script/calendar/grid.js"></script>
    <script src="script/calendar/entry.js"></script>
    <script src="script/calendar/calendar.js"></script>
    <script src="script/calendar/draganddrop.js"></script>
    <script src="script/map.js"></script>

    <title>Trans-Europe-Planner</title>

</head>

<body>

<!-- date label at the top of calendar -->
<template id="template-calendar-grid-date">
    <div class="calendar-grid-date"></div>
</template>

<!-- hour label at the left side of calendar -->
<template id="template-calendar-grid-hour">
    <div class="calendar-grid-hour"></div>
</template>

<!-- the cells of the calendar -->
<template id="template-calendar-grid-cell">
    <div class="calendar-grid-cell"></div>
</template>

<!-- the connections to be displayed in the calendar -->
<template id="template-calendar-connection">
    <div class="calendar-connection">
        <img class="connection-icon">
        <span class="connection-number"></span>
        <span class="connection-start-time"></span>
        <span class="connection-start-station"></span>
        <span class="connection-end-time"></span>
        <span class="connection-end-station"></span>
    </div>
</template>

<!-- less info about the connection because of less space -->
<template id="template-calendar-connection-short">
    <div class="calendar-connection">
        <img class="connection-icon">
        <span class="connection-number"></span>
    </div>
</template>


<div id="map"></div>
<!-- All calendar elements will be added into the container below dynamically -->
<calendar-grid id="calendar" start="2024-10-16" end="2024-10-18" resolution="4"></calendar-grid>


<script>
  function main(map){

    // temporary
    const defaultConnections = {
      "Berlin-München": "2024-10-16XICE505XBerlin-München",
      "München-Verona": "2024-10-16XEC87XMünchen-Verona",
      "Verona-Firenze": "2024-10-17XFR8503XVerona-Firenze",
      "Firenze-Livorno": "2024-10-17XR18289XFirenze-Livorno",
      "Livorno-Bastia": "2024-10-18XCF1XLivorno-Bastia",
      "Berlin-Zürich": "2024-10-16XICE73XBerlin-Zürich",
      "Zürich-Genova": "2024-10-17XEC327XZürich-Genova",
      "Berlin-Karlsruhe": "2024-10-16XICE71XBerlin-Karlsruhe",
      "Karlsruhe-Marseille": "2024-10-16XTGV9580XKarlsruhe-Marseille"
    }

    const connections = prepareData(CITIES, STATIONS, CONNECTIONS, Object.keys(defaultConnections));
    const database = new Database(connections);




    const journey = new Journey([]);
    //journey.addConnection(defaultConnections["Berlin-München"]);
    //journey.addConnection(defaultConnections["München-Verona"]);
    journey.addConnection(database.getConnection(defaultConnections["Berlin-Karlsruhe"]));
    journey.addConnection(database.getConnection(defaultConnections["Karlsruhe-Marseille"]));
    //journey.addConnection(defaultConnections["Verona-Firenze"]);

    const calendar = document.getElementById("calendar");

    map.init();
    map.updateView(database.prepareDataForMap(journey));
    calendar.updateView(database.prepareDataForCalendar(journey));

    calendar.on("entryStartHover", leg => map.setHover(leg));
    calendar.on("entryStopHover", leg => map.setNoHover(leg));
    map.on("legStartHover", leg => calendar.setHover(leg));
    map.on("legStopHover", leg => calendar.setNoHover(leg));

    map.on("legAdded", leg => {
      journey.addConnection(database.getConnection(defaultConnections[leg]));
      map.updateView(database.prepareDataForMap(journey));
      calendar.updateView(database.prepareDataForCalendar(journey));
    });

    map.on("legRemoved", leg => {
      journey.removeConnection(leg);
      map.updateView(database.prepareDataForMap(journey));
      calendar.updateView(database.prepareDataForCalendar(journey));
    });

    calendar.on("legChanged", (leg, connectionId) => {
      journey.changeLeg(leg, database.getConnection(connectionId));
      calendar.updateView(database.prepareDataForCalendar(journey));
    });
  }

  onload = (event) => {
    const map = new MapWrapper(new maplibregl.Map({
      container: 'map',
      style: "style/outdoors-modified.json",
      center: [13.408333, 52.518611],
      zoom: 4
    }));

    map.map.on('load', () => {
      try {
        main(map);
      } catch(error) {
        console.error(error);
      }

    });
  };
</script>

</body>
</html>
