<!DOCTYPE html>
<html lang="de">

<head>
    <meta name="description" content="Ohne Flugzeug quer durch Europa"/>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- maplibre -->
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.6.0/dist/maplibre-gl.css"/>
    <script src="https://unpkg.com/maplibre-gl@4.6.0/dist/maplibre-gl.js"></script>

    <!-- styles -->
    <link rel="stylesheet" href="style/style.css">
    <link rel="stylesheet" href="style/calendar.css">

    <!-- scripts -->
    <script src="style/map.js"></script> <!-- only contains css styles for map in js -->

    <script src="script/util.js"></script>
    <script src="script/types.js"></script>

    <script src="script/data/stations.js"></script>
    <script src="script/data/connections.js"></script>
    <script src="script/database.js"></script>

    <script src="script/calendar.js"></script>
    <script src="script/map.js"></script>

    <title>Trans-Europe-Planner</title>

</head>

<body>

<div id="map"></div>
<div id="calendar">

    <!-- date label at the top of calendar -->
    <template id="template-calendar-grid-date">
        <div class="calendar-grid-date"></div>
    </template>

    <!-- hour label at the left side of calendar -->
    <template id="template-calendar-grid-hour">
        <div class="calendar-grid-hour"></div>
    </template>

    <!-- the cells of the calendar -->
    <template id="template-calendar-grid-cell">
        <div class="calendar-grid-cell"></div>
    </template>

    <!-- the connections to be displayed in the calendar -->
    <template id="template-calendar-connection">
        <div class="calendar-connection" draggable="true">
            <img class="connection-icon">
            <span class="connection-number"></span>
            <span class="connection-start-time"></span>
            <span class="connection-start-station"></span>
            <span class="connection-end-time"></span>
            <span class="connection-end-station"></span>
        </div>
    </template>

    <!-- All calendar elements will be added into the container below dynamically -->
    <div id="calendar-grid"></div>

</div>


<script>

    "use strict";
    const database = new Database();

    function main(){
        const availableLegs = Array.from(database.getAllLegs());

        // temporary
        const defaultConnections = {
            "Berlin-M端nchen": database.getConnection("2024-10-16X1000505"),
            "M端nchen-Verona": database.getConnection("2024-10-16X300087"),
            "Verona-Firenze": database.getConnection("2024-10-17X40008503"),
            "Firenze-Livorno": database.getConnection("2024-10-17X500018289"),
            "Livorno-Bastia": database.getConnection("2024-10-18X1234567")
        }

        const journey = new Journey([]);
        journey.addConnection(defaultConnections["Berlin-M端nchen"]);
        journey.addConnection(defaultConnections["M端nchen-Verona"]);

        const calendarDiv = document.getElementById("calendar-grid");
        const style = getComputedStyle(calendarDiv);
        const resolution = Number(style.getPropertyValue("--resolution"));
        const startDay = new Date("2024-10-16");
        const endDay = new Date("2024-10-18");

        const calendar = new Calendar(calendarDiv, startDay, endDay, resolution);

        map.init();
        map.updateView(availableLegs,journey);
        calendar.updateView(journey);

        map.on("legAdded", leg => {
            journey.addConnection(defaultConnections[leg]);
            map.updateView(availableLegs,journey);
            calendar.updateView(journey);
        });

        map.on("legRemoved", leg => {
            journey.removeConnection(leg);
            map.updateView(availableLegs,journey);
            calendar.updateView(journey);
        });

        calendar.on("legChanged", data => {
            journey.changeLeg(data.leg, database.getConnection(data.id));
            calendar.updateView(journey);
        })

    }

    const map = new MapWrapper(new maplibregl.Map({
      container: 'map',
      style: "style/outdoors-modified.json",
      center: [13.408333, 52.518611],
      zoom: 4
    }));

    map.map.on('load', () => {
        main();
    });
</script>

</body>
</html>
